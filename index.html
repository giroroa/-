<!DOCTYPE html>
<html lang="zh-TW">
<head>
Â  <meta charset="UTF-8">
Â  <meta name="viewport" content="width=device-width, initial-scale=1.0">
Â  <title>æŠ½çç³»çµ±</title>
Â  <script src="https://cdn.tailwindcss.com"></script>
Â  <meta name="apple-mobile-web-app-capable" content="yes">
Â  <meta name="apple-mobile-web-app-status-bar-style" content="default">
Â  <meta name="theme-color" content="#10b981">
Â  <style>
Â  Â  /* è‡ªå®šç¾©å‹•ç•«ï¼Œä½¿æŠ½çä¸­çš„æ–‡å­—æ›´å¹³æ»‘ */
Â  Â  @keyframes pulse {
Â  Â  Â  0%, 100% { opacity: 1; }
Â  Â  Â  50% { opacity: 0.5; }
Â  Â  }
Â  Â  .animate-pulse-custom {
Â  Â  Â  animation: pulse 1.5s infinite;
Â  Â  }
Â  </style>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center px-4">
Â  <div class="bg-white p-6 rounded shadow-md w-full max-w-md text-center">
Â  Â  <h1 class="text-2xl font-bold mb-4 text-gray-800">æŠ½çç³»çµ±</h1>

Â  Â  <div class="mb-4">
Â  Â  Â  <label for="phoneInput" class="sr-only">æ‰‹æ©Ÿè™Ÿç¢¼</label>
Â  Â  Â  <input id="phoneInput" 
Â  Â  Â  Â  Â  Â type="tel" 
Â  Â  Â  Â  Â  Â maxlength="10" 
Â  Â  Â  Â  Â  Â placeholder="è¼¸å…¥æ‰‹æ©Ÿè™Ÿç¢¼ (09xxxxxxxx)" 
Â  Â  Â  Â  Â  Â class="p-2 border rounded w-full text-center focus:ring-green-500 focus:border-green-500" 
Â  Â  Â  Â  Â  Â pattern="09\d{8}" 
Â  Â  Â  Â  Â  Â title="è«‹è¼¸å…¥æ­£ç¢ºçš„10ä½æ‰‹æ©Ÿè™Ÿç¢¼ï¼Œä»¥09é–‹é ­"
Â  Â  Â  Â  Â  Â aria-describedby="phone-error" />
Â  Â  Â  <p id="phone-error" class="text-red-500 text-sm mt-1 hidden" role="alert"></p>
Â  Â  </div>
Â  Â  
Â  Â  <button id="drawBtn" class="bg-green-500 text-white py-2 px-4 rounded w-full hover:bg-green-600 transition duration-300 ease-in-out">é–‹å§‹æŠ½ç</button>
Â  Â  
Â  Â  <div id="animation" class="my-4 hidden text-lg font-semibold text-green-700 animate-pulse-custom">ğŸ‰ æŠ½çä¸­...</div>
Â  Â  <div id="result" class="text-xl font-bold my-4"></div>
Â  Â  
Â  Â  <div class="border-t border-gray-200 mt-6 pt-6">
Â  Â  Â  <div id="historyTitle" class="text-gray-800 font-semibold mb-2">ğŸ“œ ä»Šæ—¥æŠ½çç´€éŒ„</div>
Â  Â  Â  <ul id="recordList" class="text-sm text-left max-h-48 overflow-y-auto mt-2 border border-gray-200 p-2 rounded bg-gray-50"></ul>
Â  Â  </div>
Â  </div>

Â  <script>
Â  Â  // è«‹æ›¿æ›ç‚ºæ‚¨éƒ¨ç½²å¾Œçš„ Google Apps Script ç¶²è·¯æ‡‰ç”¨ç¨‹å¼ URL
Â  Â  const apiUrl = "https://script.google.com/macros/s/AKfycbzzaSlIj87CnFaTYLLkr4-oDse4Y-OlVyS7CccgwDpHqWwvtytsHXgAFGeYypqaomDoKQ/exec";

Â  Â  const phoneInput = document.getElementById("phoneInput");
Â  Â  const drawBtn = document.getElementById("drawBtn");
Â  Â  const animationDiv = document.getElementById("animation");
Â  Â  const resultDiv = document.getElementById("result");
Â  Â  const recordList = document.getElementById("recordList");
Â  Â  const phoneError = document.getElementById("phone-error");

Â  Â  let loadingInterval; // ç”¨æ–¼æ§åˆ¶å‹•ç•«é–“éš”çš„è®Šæ•¸

Â  Â  // æŠ½çå‡½æ•¸
Â  Â  async function drawPrize() {
Â  Â  Â  const phone = phoneInput.value.trim();

Â  Â  Â  // æ‰‹æ©Ÿè™Ÿç¢¼é©—è­‰
Â  Â  Â  if (!phone) {
Â  Â  Â  Â  showError("æ‰‹æ©Ÿè™Ÿç¢¼ä¸èƒ½ç‚ºç©ºã€‚");
Â  Â  Â  Â  return;
Â  Â  Â  }
Â  Â  Â  if (!/^09\d{8}$/.test(phone)) {
Â  Â  Â  Â  showError("è«‹è¼¸å…¥æ­£ç¢ºçš„10ä½æ‰‹æ©Ÿè™Ÿç¢¼ï¼Œå¿…é ˆä»¥09é–‹é ­ã€‚");
Â  Â  Â  Â  return;
Â  Â  Â  }
Â  Â  Â  hideError(); // é©—è­‰é€šéï¼Œéš±è—éŒ¯èª¤è¨Šæ¯

Â  Â  Â  // ç¦ç”¨æŒ‰éˆ•ï¼Œé¡¯ç¤ºå‹•ç•«
Â  Â  Â  drawBtn.disabled = true;
Â  Â  Â  animationDiv.classList.remove("hidden");
Â  Â  Â  resultDiv.textContent = ""; // æ¸…ç©ºèˆŠçš„çµæœè¨Šæ¯

Â  Â  Â  // æŠ½çå‹•ç•«çš„é»é»æ•ˆæœ
Â  Â  Â  let dots = 1;
Â  Â  Â  loadingInterval = setInterval(() => {
Â  Â  Â  Â  animationDiv.textContent = `ğŸ‰ æŠ½çä¸­${".".repeat(dots++ % 4)}`;
Â  Â  Â  }, 300);

Â  Â  Â  try {
Â  Â  Â  Â  const res = await fetch(apiUrl, {
Â  Â  Â  Â  Â  method: "POST",
Â  Â  Â  Â  Â  body: JSON.stringify({ action: "draw", phone }),
Â  Â  Â  Â  Â  headers: { "Content-Type": "application/json" }
Â  Â  Â  Â  });

Â  Â  Â  Â  // æª¢æŸ¥ HTTP éŸ¿æ‡‰ç‹€æ…‹
Â  Â  Â  Â  if (!res.ok) {
Â  Â  Â  Â  Â  const errorBody = await res.text();
Â  Â  Â  Â  Â  throw new Error(`ç¶²è·¯è«‹æ±‚å¤±æ•—: ${res.status} - ${errorBody}`);
Â  Â  Â  Â  }

Â  Â  Â  Â  const data = await res.json();

Â  Â  Â  Â  // åœæ­¢å‹•ç•«
Â  Â  Â  Â  clearInterval(loadingInterval);
Â  Â  Â  Â  animationDiv.classList.add("hidden");

Â  Â  Â  Â  // é¡¯ç¤ºæŠ½ççµæœ
Â  Â  Â  Â  if (data.error) {
Â  Â  Â  Â  Â  resultDiv.className = "text-xl font-bold my-4 text-red-600";
Â  Â  Â  Â  Â  resultDiv.textContent = `ğŸš« æŠ½çå¤±æ•—: ${data.error}`;
Â  Â  Â  Â  Â  console.error("Apps Script è¿”å›éŒ¯èª¤:", data.details || data.error);
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  resultDiv.className = "text-xl font-bold my-4 text-green-600";
Â  Â  Â  Â  Â  resultDiv.textContent = `ğŸ æŠ½ä¸­ï¼š${data.result}`;
Â  Â  Â  Â  Â  phoneInput.value = ""; // æŠ½çæˆåŠŸå¾Œæ¸…ç©ºæ‰‹æ©Ÿè™Ÿç¢¼
Â  Â  Â  Â  }
Â  Â  Â  Â  // ç„¡è«–æˆåŠŸæˆ–å¤±æ•—ï¼Œéƒ½é‡æ–°è¼‰å…¥ç´€éŒ„
Â  Â  Â  Â  loadRecords();
Â  Â  Â  } catch (err) {
Â  Â  Â  Â  clearInterval(loadingInterval);
Â  Â  Â  Â  animationDiv.classList.add("hidden");
Â  Â  Â  Â  resultDiv.className = "text-xl font-bold my-4 text-red-600";
Â  Â  Â  Â  resultDiv.textContent = `ğŸš¨ æŠ½çéç¨‹å‡ºéŒ¯ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚`;
Â  Â  Â  Â  console.error("æŠ½çè«‹æ±‚ç™¼ç”ŸéŒ¯èª¤:", err);
Â  Â  Â  } finally {
Â  Â  Â  Â  drawBtn.disabled = false; // ç„¡è«–å¦‚ä½•éƒ½å•Ÿç”¨æŒ‰éˆ•
Â  Â  Â  }
Â  Â  }

Â  Â  // è¼‰å…¥æŠ½çç´€éŒ„å‡½æ•¸
Â  Â  async function loadRecords() {
Â  Â  Â  try {
Â  Â  Â  Â  const res = await fetch(apiUrl + "?action=getRecords");
Â  Â  Â  Â  if (!res.ok) {
Â  Â  Â  Â  Â  throw new Error(`ç„¡æ³•è¼‰å…¥ç´€éŒ„: ${res.status}`);
Â  Â  Â  Â  }
Â  Â  Â  Â  const data = await res.json();

Â  Â  Â  Â  recordList.innerHTML = ""; // æ¸…ç©ºèˆŠç´€éŒ„

Â  Â  Â  Â  // ç²å–ä»Šå¤©çš„æ—¥æœŸï¼Œæ ¼å¼ç‚º YYYY/MM/DD (èˆ‡ Google Sheets é è¨­æ ¼å¼åŒ¹é…)
Â  Â  Â  Â  const now = new Date();
Â  Â  Â  Â  const todayYear = now.getFullYear();
Â  Â  Â  Â  const todayMonth = (now.getMonth() + 1).toString().padStart(2, '0');
Â  Â  Â  Â  const todayDay = now.getDate().toString().padStart(2, '0');
Â  Â  Â  Â  const todaySheetFormat = `${todayYear}/${todayMonth}/${todayDay}`;

Â  Â  Â  Â  if (data && data.length > 0) {
Â  Â  Â  Â  Â  data.filter(r => r.time && r.time.startsWith(todaySheetFormat)) // éæ¿¾ä»Šæ—¥ç´€éŒ„
Â  Â  Â  Â  Â  Â  Â  .reverse() // æœ€æ–°ç´€éŒ„é¡¯ç¤ºåœ¨æœ€ä¸Šæ–¹
Â  Â  Â  Â  Â  Â  Â  .forEach(r => {
Â  Â  Â  Â  Â  Â  Â  Â  const li = document.createElement("li");
Â  Â  Â  Â  Â  Â  Â  Â  // æ ¼å¼åŒ–æ™‚é–“ç‚º HH:MM:SS
Â  Â  Â  Â  Â  Â  Â  Â  const recordDateTime = new Date(r.time);
Â  Â  Â  Â  Â  Â  Â  Â  const formattedTime = recordDateTime.toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false });
Â  Â  Â  Â  Â  Â  Â  Â  li.textContent = `[${formattedTime}] ${r.phone} â†’ ${r.result}`;
Â  Â  Â  Â  Â  Â  Â  Â  recordList.appendChild(li);
Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  recordList.innerHTML = '<li class="text-gray-500">ç›®å‰æ²’æœ‰ä»Šæ—¥æŠ½çç´€éŒ„ã€‚</li>';
Â  Â  Â  Â  }
Â  Â  Â  } catch (err) {
Â  Â  Â  Â  console.error("è¼‰å…¥æŠ½çç´€éŒ„å¤±æ•—:", err);
Â  Â  Â  Â  recordList.innerHTML = `<li class="text-red-500">ç„¡æ³•è¼‰å…¥æŠ½çç´€éŒ„ã€‚</li>`;
Â  Â  Â  }
Â  Â  }

Â  Â  // é¡¯ç¤ºæ‰‹æ©Ÿè™Ÿç¢¼éŒ¯èª¤è¨Šæ¯
Â  Â  function showError(message) {
Â  Â  Â  phoneError.textContent = message;
Â  Â  Â  phoneError.classList.remove("hidden");
Â  Â  Â  phoneInput.classList.add("border-red-500", "focus:border-red-500");
Â  Â  Â  phoneInput.focus();
Â  Â  }

Â  Â  // éš±è—æ‰‹æ©Ÿè™Ÿç¢¼éŒ¯èª¤è¨Šæ¯
Â  Â  function hideError() {
Â  Â  Â  phoneError.classList.add("hidden");
Â  Â  Â  phoneInput.classList.remove("border-red-500", "focus:border-red-500");
Â  Â  }

Â  Â  // äº‹ä»¶ç›£è½å™¨
Â  Â  document.addEventListener('DOMContentLoaded', () => {
Â  Â  Â  loadRecords(); // é é¢è¼‰å…¥æ™‚è‡ªå‹•è¼‰å…¥ç´€éŒ„

Â  Â  Â  // é»æ“ŠæŠ½çæŒ‰éˆ•
Â  Â  Â  drawBtn.addEventListener('click', drawPrize);

Â  Â  Â  // æ‰‹æ©Ÿè™Ÿç¢¼è¼¸å…¥æ¡†æŒ‰ä¸‹ Enter éµè§¸ç™¼æŠ½ç
Â  Â  Â  phoneInput.addEventListener('keypress', function(event) {
Â  Â  Â  Â  if (event.key === 'Enter') {
Â  Â  Â  Â  Â  event.preventDefault(); // é˜»æ­¢ Enter éµé è¨­è¡Œç‚º
Â  Â  Â  Â  Â  drawPrize();
Â  Â  Â  Â  }
Â  Â  Â  });

Â  Â  Â  // ç•¶è¼¸å…¥æ¡†å…§å®¹æ”¹è®Šæ™‚éš±è—éŒ¯èª¤è¨Šæ¯
Â  Â  Â  phoneInput.addEventListener('input', hideError);
Â  Â  });
Â  </script>
</body>
</html>
